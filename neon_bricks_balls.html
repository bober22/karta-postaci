<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Neon Bricks & Balls ‚Äì PTKM</title>
<style>
  :root{ --bg:#0a0b10; --fg:#e6f3ff; --neon1:#00e7ff; --neon2:#ff00e6; --neon3:#00ff95; --glass:rgba(255,255,255,.06); }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,Segoe UI,Roboto,sans-serif; color:var(--fg);
    background: radial-gradient(1000px 600px at 15% 0%,#121533 0%,#08090f 60%,#05060b 100%),
                radial-gradient(900px 500px at 90% 100%,#1a0029 0%,#07070c 60%,#05060b 100%);
    overflow:hidden; touch-action:none; user-select:none;
  }
  .wrap{position:relative; width:100%; height:100%; display:grid; place-items:center; padding:16px;}
  canvas{
    width:100%; max-width:540px; aspect-ratio:9/16; border-radius:18px; background:#06070d;
    box-shadow:0 0 0 2px rgba(255,255,255,.03) inset, 0 0 60px #000; touch-action:none;
  }
  .hud{position:absolute; top:12px; left:50%; transform:translateX(-50%); width:min(92vw,540px);
       display:flex; justify-content:space-between; gap:10px; pointer-events:none; z-index:5;}
  .chip{pointer-events:auto; background:var(--glass); backdrop-filter:blur(8px);
        border:1px solid rgba(255,255,255,.12); border-radius:999px; padding:8px 12px; display:flex; gap:8px; align-items:center;}
  .chip b{color:var(--neon1)}
  .chip .btn{all:unset; cursor:pointer; padding:.35rem .8rem; border-radius:999px; color:#fff; font-weight:700;
             background:linear-gradient(90deg,var(--neon1),var(--neon2));}
  .overlay{position:absolute; inset:0; display:none; place-items:center; padding:16px; z-index:8;}
  .panel{width:min(92vw,540px); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
         border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:22px;}
  .title{font-size:clamp(28px,5vw,42px); font-weight:900; letter-spacing:.02em; margin:6px 0 12px;
         background:linear-gradient(90deg,var(--neon1),var(--neon2)); -webkit-background-clip:text; background-clip:text; color:transparent;}
  .btn{all:unset; cursor:pointer; display:inline-block; background:linear-gradient(90deg,var(--neon1),var(--neon2));
       color:#fff; font-weight:800; letter-spacing:.04em; padding:10px 16px; border-radius:12px; }
  .btn.outline{background:transparent; border:1px solid rgba(255,255,255,.2)}
</style>
</head>
<body>
  <div class="wrap" style="position:relative;width:100%;height:100%;display:grid;place-items:center;padding:16px;touch-action:none;user-select:none;background:#05060b;">
    <canvas id="game" aria-label="Neon Bricks & Balls" style="width:100%;max-width:540px;aspect-ratio:9/16;border-radius:18px;background:#06070d;box-shadow:0 0 0 2px rgba(255,255,255,.03) inset, 0 0 60px #000;"></canvas>

    <!-- HUD -->
    <div class="hud" style="position:absolute;top:12px;left:50%;transform:translateX(-50%);width:min(92vw,540px);display:flex;justify-content:space-between;gap:10px;pointer-events:none;z-index:5;font-family:system-ui,Segoe UI,Roboto,sans-serif;color:#e6f3ff;">
      <div style="pointer-events:auto;background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:8px 12px;display:flex;gap:8px;align-items:center;">Runda: <b id="round" style="color:#00e7ff">1</b></div>
      <div style="pointer-events:auto;background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:8px 12px;display:flex;gap:8px;align-items:center;">Pi≈Çki: <b id="balls" style="color:#00e7ff">1</b></div>
      <div style="pointer-events:auto;background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:8px 12px;display:flex;gap:8px;align-items:center;">Rekord: <b id="best" style="color:#00e7ff">0</b> <button id="restart" style="all:unset;cursor:pointer;padding:.35rem .8rem;border-radius:999px;color:#fff;font-weight:700;background:linear-gradient(90deg,#00e7ff,#ff00e6)">‚Üª</button></div>
    </div>

    <!-- Menu -->
    <div id="menu" style="position:absolute;inset:0;display:grid;place-items:center;padding:16px;z-index:8;">
      <div style="width:min(92vw,540px);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:22px;color:#e6f3ff;font-family:system-ui,Segoe UI,Roboto,sans-serif;">
        <div style="font-size:clamp(28px,5vw,42px);font-weight:900;letter-spacing:.02em;margin:6px 0 12px;background:linear-gradient(90deg,#00e7ff,#ff00e6);-webkit-background-clip:text;background-clip:text;color:transparent;">NEON BRICKS & BALLS</div>
        <p>Przytrzymaj palec/mysz, aby celowaƒá. <b>Pu≈õƒá</b> ‚Äî strza≈Ç. Po turze klocki zje≈ºd≈ºajƒÖ o 1 i pojawia siƒô nowa linia. Zbieraj zielone <b>‚óè</b> (+1 pi≈Çka).</p>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button id="start" style="all:unset;cursor:pointer;display:inline-block;background:linear-gradient(90deg,#00e7ff,#ff00e6);color:#fff;font-weight:800;letter-spacing:.04em;padding:10px 16px;border-radius:12px;">‚ñ∂ Start</button>
          <button id="clear" style="all:unset;cursor:pointer;display:inline-block;background:transparent;border:1px solid rgba(255,255,255,.2);color:#e6f3ff;font-weight:800;letter-spacing:.04em;padding:10px 16px;border-radius:12px;">Wyczy≈õƒá rekord</button>
        </div>
      </div>
    </div>

    <!-- Game Over -->
    <div id="gameover" style="position:absolute;inset:0;display:none;place-items:center;padding:16px;z-index:8;">
      <div style="width:min(92vw,540px);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:22px;color:#e6f3ff;font-family:system-ui,Segoe UI,Roboto,sans-serif;">
        <div style="font-size:clamp(28px,5vw,42px);font-weight:900;letter-spacing:.02em;margin:6px 0 12px;background:linear-gradient(90deg,#00e7ff,#ff00e6);-webkit-background-clip:text;background-clip:text;color:transparent;">Koniec gry</div>
        <p>Runda: <b id="finalRound">0</b> ‚Ä¢ Rekord: <b id="finalBest">0</b></p>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button id="again" style="all:unset;cursor:pointer;display:inline-block;background:linear-gradient(90deg,#00e7ff,#ff00e6);color:#fff;font-weight:800;letter-spacing:.04em;padding:10px 16px;border-radius:12px;">‚Üª Jeszcze raz</button>
          <button id="toMenu" style="all:unset;cursor:pointer;display:inline-block;background:transparent;border:1px solid rgba(255,255,255,.2);color:#e6f3ff;font-weight:800;letter-spacing:.04em;padding:10px 16px;border-radius:12px;">üè† Menu</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Sta≈Çe / kanwa ===== */
const DPR=Math.max(1,Math.min(devicePixelRatio||1,2));
const W=540,H=960,COLS=8,CELL=Math.floor((W-40)/COLS);
const LEFT=Math.floor((W-COLS*CELL)/2),TOP=110,ROW_H=CELL;
const BALL_R=6,EMIT_DELAY=60,MAX_STEP=1/120;
const canvas=document.getElementById('game'); const ctx=canvas.getContext('2d');

function resize(){
  const cssW=Math.min(innerWidth-32,540), cssH=cssW*(16/9);
  canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px';
  canvas.width=Math.floor(W*DPR); canvas.height=Math.floor(H*DPR);
}
addEventListener('resize',resize,{passive:true}); resize();

/* ===== Stan gry ===== */
const State={MENU:0,AIM:1,FLY:2,OVER:3};
let state=State.MENU;
let round=1, score=0, ballsCount=1;
let baseLaunchPos={x:W/2,y:H-40}, nextLaunchPos={...baseLaunchPos};
let balls=[], orbs=[];
/* Bricks jako mapa: key "r,c" -> {row,col,hp}  (szybki dostƒôp lokalny) */
const bricks=new Map();

let dragging=false, aimFrom=null, aimTo=null, fastReturn=false;
let best=Number(localStorage.getItem('nbb_best')||0);

const uiRound=document.getElementById('round');
const uiBalls=document.getElementById('balls');
const uiBest=document.getElementById('best');
const menuEl=document.getElementById('menu');
const overEl=document.getElementById('gameover');
const finalRound=document.getElementById('finalRound');
const finalBest=document.getElementById('finalBest');
uiBest.textContent=best;

const CONFIG={ orbChance:.45, hardBonusChance:.22, veryHardBonusChance:.10, baseHpGrowth:.7 };

/* ===== Utils ===== */
const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
function show(menu,over){ menuEl.style.display=menu?'grid':'none'; overEl.style.display=over?'grid':'none'; }
function toWorldFromEvent(e){
  const r=canvas.getBoundingClientRect(); let x,y;
  if(e.touches?.[0]){ x=e.touches[0].clientX; y=e.touches[0].clientY; }
  else if(e.changedTouches?.[0]){ x=e.changedTouches[0].clientX; y=e.changedTouches[0].clientY; }
  else { x=e.clientX; y=e.clientY; }
  return { x:(x-r.left)/r.width*W, y:(y-r.top)/r.height*H };
}
const key=(r,c)=>r+','+c;

/* ===== Spawn rzƒôdu (z mapƒÖ) ===== */
function spawnRow(){
  // zsu≈Ñ istniejƒÖce
  const moved=new Map();
  for(const b of bricks.values()){
    const nr=b.row+1; const nc=b.col;
    moved.set(key(nr,nc), {row:nr,col:nc,hp:b.hp});
  }
  bricks.clear(); for(const v of moved.values()) bricks.set(key(v.row,v.col),v);

  for(const o of orbs) o.row++;

  // nowa linia
  const baseHP=1+Math.floor((round-1)*CONFIG.baseHpGrowth);
  const newCols=[];
  for(let c=0;c<COLS;c++){
    if(Math.random()<.70){
      let hp=baseHP;
      if(Math.random()<CONFIG.hardBonusChance) hp++;
      if(Math.random()<CONFIG.veryHardBonusChance) hp++;
      const b={row:0,col:c,hp};
      bricks.set(key(0,c),b); newCols.push(c);
    }
  }
  // orb w pustej kolumnie
  if(Math.random()<CONFIG.orbChance){
    const free=[...Array(COLS).keys()].filter(c=>!newCols.includes(c));
    if(free.length) orbs.push({row:0,col:free[(Math.random()*free.length)|0]});
  }
}

/* ===== Start / Over ===== */
function startGame(){
  round=1; score=0; ballsCount=1; balls.length=0; orbs.length=0; bricks.clear();
  baseLaunchPos={x:W/2,y:H-40}; nextLaunchPos={...baseLaunchPos};
  spawnRow(); state=State.AIM; uiRound.textContent=round; uiBalls.textContent=ballsCount; show(false,false);
}
function gameOver(){
  state=State.OVER; best=Math.max(best,round-1); localStorage.setItem('nbb_best',best); uiBest.textContent=best;
  finalRound.textContent=round-1; finalBest.textContent=best; show(false,true);
}

/* ===== Strza≈Ç ===== */
function launch(angle){
  const a=clamp(angle,-Math.PI+0.05,-0.05);
  balls.length=0; const speed=540;
  for(let i=0;i<ballsCount;i++){
    balls.push({x:baseLaunchPos.x,y:baseLaunchPos.y,r:BALL_R,vx:Math.cos(a)*speed,vy:Math.sin(a)*speed,delay:i*EMIT_DELAY,active:false});
  }
  state=State.FLY;
}

/* ===== POMOCNICZE: iteracja sƒÖsiad√≥w kom√≥rki (kolizje szybkie) ===== */
function forNearbyBricks(x,y,cb){
  // indeks kom√≥rki pod pi≈ÇkƒÖ
  const c = Math.floor((x-LEFT)/CELL);
  const r = Math.floor((y-TOP)/ROW_H);
  for(let rr=r-1; rr<=r+1; rr++){
    if(rr<0) continue;
    for(let cc=c-1; cc<=c+1; cc++){
      if(cc<0 || cc>=COLS) continue;
      const b = bricks.get(key(rr,cc));
      if(b) cb(b);
    }
  }
}

/* ===== Fizyka + KONIEC TURY (optymalizowane) ===== */
function updateBalls(dt){
  // 1) Fizycznie zaktualizuj pi≈Çki
  for(const b of balls){
    if(b.delay>0){ b.delay -= dt*1000; continue; }
    if(!b.active) b.active=true;

    const mul = fastReturn && b.vy>0 ? 1.8 : 1;
    let tleft=dt*mul, step=MAX_STEP;

    while(tleft>0){
      const t=Math.min(step,tleft);
      b.x += b.vx*t; b.y += b.vy*t;

      // ≈õciany
      if(b.x < b.r){ b.x=b.r; b.vx=Math.abs(b.vx); }
      if(b.x > W-b.r){ b.x=W-b.r; b.vx=-Math.abs(b.vx); }
      if(b.y < TOP + b.r){ b.y=TOP + b.r; b.vy=Math.abs(b.vy); }

      // *** tylko pobliskie klocki ***
      forNearbyBricks(b.x,b.y,(k)=>{
        const rx=LEFT+k.col*CELL, ry=TOP+k.row*ROW_H, rw=CELL, rh=ROW_H;
        if(b.x+b.r<rx || b.x-b.r>rx+rw || b.y+b.r<ry || b.y-b.r>ry+rh) return;
        const prevX=b.x-b.vx*t, prevY=b.y-b.vy*t;
        const wasX=prevX>=rx && prevX<=rx+rw, wasY=prevY>=ry && prevY<=ry+rh;
        if(wasX) b.vy*=-1; else if(wasY) b.vx*=-1; else { b.vx*=-1; b.vy*=-1; }
        k.hp--; if(k.hp<=0) bricks.delete(key(k.row,k.col)); score++;
      });

      // orby (+1) ‚Äî jest ich ma≈Ço, wiƒôc pƒôtla prosta
      for(const o of orbs){
        const ox=LEFT+o.col*CELL+CELL/2, oy=TOP+o.row*ROW_H+ROW_H/2;
        const d2=(ox-b.x)**2+(oy-b.y)**2;
        if(d2 < (BALL_R+8)**2){ o.col=-999; }
      }

      tleft -= t;

      // dno ‚Üí pi≈Çka wr√≥ci≈Ça
      if(b.y > H-26){
        if(nextLaunchPos && nextLaunchPos._set!==true) nextLaunchPos={x:b.x,y:baseLaunchPos.y,_set:true};
        b.active=false; b.vx=0; b.vy=0; b.y=H-20;
        break;
      }
    }
  }

  // 2) zbierz orby
  let gained=0;
  orbs=orbs.filter(o=>o.col>=0 || (++gained, false));
  if(gained){ ballsCount+=gained; uiBalls.textContent=ballsCount; }

  // 3) KONIEC TURY (wa≈ºne: liczymy dopiero po starcie WSZYSTKICH pi≈Çek)
  const allReturned = balls.every(b => b.delay<=0 && !b.active);
  if(allReturned && state===State.FLY){
    if(nextLaunchPos && nextLaunchPos._set){
      baseLaunchPos={x:clamp(nextLaunchPos.x, LEFT+BALL_R, LEFT+COLS*CELL-BALL_R), y:baseLaunchPos.y};
    }
    nextLaunchPos={...baseLaunchPos};

    spawnRow(); round++; uiRound.textContent=round;

    // przegrana?
    for(const b of bricks.values()){
      const bottom = TOP + b.row*ROW_H + ROW_H;
      if(bottom >= H-36){ gameOver(); return; }
    }

    state=State.AIM; fastReturn=false;
  }
}

/* ===== Rysowanie ‚Äî uproszczone (mniej cieni/gradient√≥w) ===== */
function roundRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function circle(x,y,r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.closePath(); }

function draw(){
  ctx.save(); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.scale(DPR,DPR);

  // ramka
  ctx.strokeStyle='rgba(0,231,255,.5)'; ctx.lineWidth=2;
  roundRect(8,8,W-16,H-16,16); ctx.stroke();

  // siatka (bardzo lekka)
  ctx.strokeStyle='rgba(255,255,255,.05)'; ctx.lineWidth=1;
  for(let r=0;r<12;r++){ const y=TOP+r*ROW_H+.5; ctx.beginPath(); ctx.moveTo(LEFT,y); ctx.lineTo(LEFT+COLS*CELL,y); ctx.stroke(); }

  // klocki (p≈Çaskie wype≈Çnienie + cienka obw√≥dka)
  for(const b of bricks.values()){
    const x=LEFT+b.col*CELL+4, y=TOP+b.row*ROW_H+4, w=CELL-8, h=ROW_H-8;
    const hue=(b.col/COLS*300)|0;
    ctx.fillStyle=`hsl(${hue} 90% 52% / .85)`; ctx.strokeStyle='rgba(255,255,255,.15)'; ctx.lineWidth=1;
    roundRect(x,y,w,h,10); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#fff'; ctx.font='700 16px system-ui,Segoe UI,Roboto'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(b.hp, x+w/2, y+h/2);
  }

  // orby
  for(const o of orbs){
    const cx=LEFT+o.col*CELL+CELL/2, cy=TOP+o.row*ROW_H+ROW_H/2;
    ctx.fillStyle='rgba(0,255,165,.9)'; circle(cx,cy,8); ctx.fill();
    ctx.fillStyle='#001d14'; ctx.font='900 12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('+', cx, cy);
  }

  // trajektoria (AIM)
  if(state===State.AIM && aimFrom && aimTo){
    const safeY=Math.min(aimTo.y, baseLaunchPos.y-2);
    const dx=aimTo.x-aimFrom.x, dy=safeY-aimFrom.y;
    const ang=Math.atan2(dy,dx), len=140, ex=baseLaunchPos.x+Math.cos(ang)*len, ey=baseLaunchPos.y+Math.sin(ang)*len;
    ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.setLineDash([6,8]); ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(baseLaunchPos.x,baseLaunchPos.y); ctx.lineTo(ex,ey); ctx.stroke(); ctx.setLineDash([]);
    ctx.fillStyle='rgba(255,255,255,.25)'; circle(aimTo.x,safeY,3.5); ctx.fill();
  }

  // pi≈Çki
  for(const b of balls){
    if(b.delay>0) continue;
    const g=ctx.createRadialGradient(b.x,b.y,1,b.x,b.y,BALL_R*1.1); g.addColorStop(0,'#fff'); g.addColorStop(1,'rgba(255,255,255,.12)');
    ctx.fillStyle=g; circle(b.x,b.y,BALL_R); ctx.fill();
  }

  // baza strza≈Çu (lekki gradient, bez cienia)
  const gr=ctx.createLinearGradient(baseLaunchPos.x-18,baseLaunchPos.y,baseLaunchPos.x+18,baseLaunchPos.y);
  gr.addColorStop(0,'rgba(0,231,255,.9)'); gr.addColorStop(1,'rgba(255,0,230,.9)');
  ctx.fillStyle=gr; roundRect(baseLaunchPos.x-20,H-28,40,10,5); ctx.fill();

  ctx.restore();
}

/* ===== Pƒôtla (miƒôkki limiter FPS) ===== */
let last=0,lastDraw=0,drawInterval=1000/45; // ~45 FPS
function loop(ts){
  requestAnimationFrame(loop);
  const dt=Math.min(0.032,(ts-last)/1000||0); last=ts;
  if(state===State.FLY) updateBalls(dt);
  if(ts-lastDraw>drawInterval){ draw(); lastDraw=ts; }
}
requestAnimationFrame(loop);

/* ===== Wej≈õcie ===== */
function aimStart(e){ if(state!==State.AIM) return; e.preventDefault(); const p=toWorldFromEvent(e); dragging=true; aimFrom={x:baseLaunchPos.x,y:baseLaunchPos.y}; aimTo=p; }
function aimMove(e){ if(!dragging) return; e.preventDefault(); aimTo=toWorldFromEvent(e); }
function aimEnd(e){
  if(!dragging) return; if(e) e.preventDefault(); dragging=false;
  if(state===State.AIM && aimFrom && aimTo){
    const safeY=Math.min(aimTo.y, baseLaunchPos.y-2);
    const dx=aimTo.x-aimFrom.x, dy=safeY-aimFrom.y; launch(Math.atan2(dy,dx));
  }
  aimFrom=null; aimTo=null;
}
if('PointerEvent' in window){
  canvas.addEventListener('pointerdown',aimStart,{passive:false});
  canvas.addEventListener('pointermove',aimMove,{passive:false});
  canvas.addEventListener('pointerup',aimEnd,{passive:false});
  canvas.addEventListener('pointercancel',aimEnd,{passive:false});
}else{
  canvas.addEventListener('touchstart',aimStart,{passive:false});
  canvas.addEventListener('touchmove',aimMove,{passive:false});
  canvas.addEventListener('touchend',aimEnd,{passive:false});
  canvas.addEventListener('mousedown',aimStart);
  addEventListener('mousemove',aimMove);
  addEventListener('mouseup',aimEnd);
}

/* ===== UI ===== */
document.getElementById('start').addEventListener('click', startGame);
document.getElementById('clear').addEventListener('click', ()=>{ localStorage.removeItem('nbb_best'); best=0; uiBest.textContent=0; });
document.getElementById('restart').addEventListener('click', startGame);
document.getElementById('again').addEventListener('click', startGame);
document.getElementById('toMenu').addEventListener('click', ()=>{ state=State.MENU; show(true,false); });

/* ===== Init ===== */
show(true,false); uiRound.textContent=round; uiBalls.textContent=ballsCount;
</script>
</body>
</html>